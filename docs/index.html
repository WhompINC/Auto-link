<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SDU Shield Explorer (Multi-Env & Search)</title>
  <style>
    html, body { height:100%; margin:0; font-family: monospace; background:#1e1e1e; color:#ddd; }
    .grid {
      display: grid;
      grid-template-columns: 200px 2fr 2fr;
      grid-template-rows: auto 1fr;
      grid-template-areas:
        "shortcuts path search"
        "shortcuts contents viewer";
      height:100%;
    }
    #shortcuts { grid-area: shortcuts; background:#2d2d2d; padding:10px; overflow:auto; }
    #path      { grid-area: path; border-bottom:1px solid #444; padding:8px; display:flex; align-items:center; }
    #search    { grid-area: search; padding:6px; margin:8px; background:#333; border:1px solid #444; color:#ddd; width:90%; }
    #contents  { grid-area: contents; padding:8px; overflow:auto; border-left:1px solid #444; border-bottom:1px solid #444; }
    #viewer    { grid-area: viewer; padding:8px; overflow:auto; }
    ul.tree { list-style:none; padding-left:16px; }
    ul.tree li { cursor:pointer; user-select:none; margin:4px 0; }
    ul.tree li::before { content: '► '; color:#6a9955; }
    ul.tree li.expanded::before { content: '▼ '; color:#6a9955; }
    ul.tree ul { display:none; margin:4px 0 4px 16px; padding:0; }
    .icon { width:1em; display:inline-block; }
    .file-item { margin:4px 0; display:flex; justify-content:space-between; }
    .file-item a { color:#569cd6; text-decoration:none; }
    .download-btn, #copy-btn, button.conf {
      background:#0e639c; border:none; padding:2px 6px; color:#fff; border-radius:2px; cursor:pointer;
    }
    .download-btn { font-size: 18px; }
    #doc-view { background:#252526; padding:8px; border:1px solid #444; height:100%; overflow:auto; white-space:pre-wrap; }
    /* Shortcuts color */
    #shortcuts a { color: #9CDCFE; text-decoration:none; display:block; margin:4px 0; padding-left:10px; }
    #shortcuts a:hover { text-decoration:underline; }
    /* Breadcrumb click style */
    #current-path span { margin-right:4px; cursor:pointer; color:#569cd6; }
    /* Control buttons */
    #back-btn, #forward-btn { background:#444; padding:5px 12px; margin-right:5px; border:none; color:white; cursor:pointer; }
    #back-btn:hover, #forward-btn:hover { background:#0e639c; }
    /* Toggle button styles */
    #env-toggle { margin-left:10px; cursor:pointer; padding:5px 15px; background-color: #444; color:white; }
    #env-toggle.active { background-color: #0e639c; }
  </style>
</head>
<body>
  <div class="grid">
    <!-- Shortcuts & Config -->
    <div id="shortcuts">
      <h3>📌 Shortcuts</h3>
      <ul id="sc-list"></ul>
    </div>
    
    <!-- Controls: Path, Environment Switch, and Search -->
    <div id="path">
      <button id="back-btn" onclick="goBack()">◀ Back</button>
      <button id="forward-btn" onclick="goForward()">Forward ▶</button>
      <strong>Path:</strong> <span id="current-path"></span>
    </div>

    <input id="search" placeholder="🔍 Search…" oninput="renderContents()" />

    <div id="contents">
      <ul id="tree" class="tree"></ul>
      <ul id="search-results" style="display:none; list-style:none; padding:0;"></ul>
    </div>

    <div id="viewer">
      <div id="doc-view"></div>
      <button id="copy-btn" style="display:none" onclick="copyText()">Copy</button>
    </div>
  </div>

  <script>
    // History stack
    let historyStack = [], historyPos = -1;
    function pushHistory(path) {
      historyStack = historyStack.slice(0, historyPos + 1);
      historyStack.push(path);
      historyPos++;
      updateNavButtons();
    }
    function goBack() {
      if(historyPos > 0) {
        historyPos--;
        navigate(historyStack[historyPos], false);
      }
    }
    function goForward() {
      if(historyPos < historyStack.length - 1) {
        historyPos++;
        navigate(historyStack[historyPos], false);
      }
    }
    function updateNavButtons() {
      document.getElementById('back-btn').disabled = historyPos <= 0;
      document.getElementById('forward-btn').disabled = historyPos >= historyStack.length - 1;
    }

    // FS & Icons
    const DEFAULT_FS = {
      LOCAL: {
        "C:": { type:"folder", children:["Files","Projects"] },
        "C:/Files": { type:"folder", children:["sdu_shield_file_tree.html","open_link.html","directory_GPT.html","README.md"] },
        "C:/Files/sdu_shield_file_tree.html": { type:"file" },
        "C:/Files/open_link.html": { type:"file" },
        "C:/Files/directory_GPT.html": { type:"file" },
        "C:/Files/README.md": { type:"file" },
        "C:/Projects": { type:"folder", children:[] }
      },
      VIRTUAL: {
        "VIRTUAL:": { type:"folder", children:["SDU-Shield","Virtual"] },
        "VIRTUAL:/SDU-Shield": { type:"folder", children:["index.html"] },
        "VIRTUAL:/SDU-Shield/index.html": { type:"file" },
        "VIRTUAL:/Virtual": { type:"folder", children:[] }
      }
    };
    const DEFAULT_ICONS = { folder:"📁", txt:"📝", md:"📄", py:"🐍", html:"🌐", c:"🔧", h:"🔨", json:"🗒️", ini:"⚙️", default:"📦" };

    let fsStore = JSON.parse(localStorage.getItem("fsStore") || "{}");
    let icons = JSON.parse(localStorage.getItem("icons") || "{}");

    if (!fsStore.LOCAL) fsStore = DEFAULT_FS;
    if (Object.keys(icons).length === 0) icons = DEFAULT_ICONS;
    localStorage.setItem("fsStore", JSON.stringify(fsStore));
    localStorage.setItem("icons", JSON.stringify(icons));

    let env = localStorage.getItem("env") || "LOCAL";
    let current = env === "LOCAL" ? "C:" : "VIRTUAL:";

    // Set Environment (LOCAL / VIRTUAL)
    function setEnv(e) {
      env = e;
      localStorage.setItem("env", env);
      current = (env === "LOCAL" ? "C:" : "VIRTUAL:");
      document.getElementById("env-toggle").textContent = `[${env}]`;
      navigate(current);
    }

    // Edit Shortcuts
    function editShortcuts() {
      const list = fsStore[env][current].children.join(",");
      const inp = prompt("Edit shortcuts for this folder, comma-separated:", list);
      if (inp !== null) {
        fsStore[env][current].children = inp.split(",").map(s => s.trim()).filter(s => s);
        localStorage.setItem("fsStore", JSON.stringify(fsStore));
        renderShortcuts();
        renderContents();
      }
    }

    // Edit Icons
    function editIcons() {
      const pairs = Object.entries(icons).map(([k, v]) => k + ":" + v).join(",");
      const inp = prompt("Edit icons ext:emoji, comma-separated:", pairs);
      if (inp !== null) {
        icons = {};
        inp.split(",").forEach(pair => {
          const [k, v] = pair.split(":");
          if (k && v) icons[k.trim()] = v.trim();
        });
        localStorage.setItem("icons", JSON.stringify(icons));
        renderContents();
      }
    }

    // Render Shortcuts
    function renderShortcuts() {
      const ul = document.getElementById("sc-list");
      ul.innerHTML = "";
      (fsStore[env][current].children || []).forEach(name => {
        const li = document.createElement("li");
        const a = document.createElement("a");
        a.href = "#";
        a.textContent = name;
        a.onclick = e => { e.preventDefault(); navigate(current + (current.endsWith(":") ? "/" : "/") + name); };
        li.appendChild(a);
        ul.appendChild(li);
      });
    }

    // Render Contents (with Search)
    function renderContents() {
      const q = document.getElementById("search").value.trim().toLowerCase();
      const tree = document.getElementById("tree");
      const sr = document.getElementById("search-results");
      tree.style.display = q ? "none" : "block";
      sr.style.display = q ? "block" : "none";
      tree.innerHTML = "";
      sr.innerHTML = "";

      if (q) {
        const itemHeight = 24;
        const pathHeight = document.getElementById("path").getBoundingClientRect().bottom;
        const avail = window.innerHeight - pathHeight - 8;
        const maxItems = Math.floor(avail / itemHeight);
        let count = 0;
        Object.keys(fsStore[env]).forEach(full => {
          const name = full.split("/").pop();
          if (name.toLowerCase().includes(q)) {
            if (count < maxItems - 1) {
              const li = document.createElement("li");
              li.className = "file-item";
              const a = document.createElement("a");
              a.href = "#";
              a.textContent = full;
              a.onclick = e => { e.preventDefault(); navigate(full); };
              li.appendChild(a);
              if (fsStore[env][full].type === "file") {
                const btn = document.createElement("button");
                btn.className = "download-btn";
                btn.textContent = "📥";
                btn.onclick = () => window.open(`https://whompinc.github.io/${full}`);
                li.appendChild(btn);
              }
              sr.appendChild(li);
              count++;
            } else if (count === maxItems - 1) {
              const li = document.createElement("li");
              li.className = "file-item";
              li.textContent = "...";
              sr.appendChild(li);
              count++;
            }
          }
        });
      } else {
        (fsStore[env][current].children || []).forEach(name => {
          const full = current + (current.endsWith(":") ? "/" : "/") + name;
          const li = document.createElement("li");
          li.className = "file-item";
          const a = document.createElement("a");
          a.href = "#";
          a.textContent = name;
          a.onclick = e => { e.preventDefault(); navigate(full); };
          li.appendChild(a);
          if (fsStore[env][full].type === "file") {
            const btn = document.createElement("button");
            btn.className = "download-btn";
            btn.textContent = "📥";
            btn.onclick = () => window.open(`https://whompinc.github.io/${full}`);
            li.appendChild(btn);
          }
          tree.appendChild(li);
        });
      }
    }

    // Render Viewer
    function renderViewer(path) {
      const dv = document.getElementById("doc-view");
      const cb = document.getElementById("copy-btn");
      if (fsStore[env][path] && fsStore[env][path].type === "file") {
        fetch(`https://whompinc.github.io/${path}`)
          .then(r => r.text())
          .then(txt => { dv.textContent = txt; cb.style.display = "inline-block"; });
      } else {
        dv.textContent = ""; cb.style.display = "none";
      }
      renderPath(path);
    }

    // Render Path
    function renderPath(path) {
      const el = document.getElementById("current-path");
      el.innerHTML = "";
      const parts = path.split("/");
      let acc = "";
      parts.forEach((p, i) => {
        acc += (i > 0 ? "/" : "") + p;
        const span = document.createElement("span");
        span.textContent = p || "/";
        span.onclick = () => navigate(acc);
        el.appendChild(span);
      });
    }

    // Navigate between directories
    function navigate(path) {
      if (fsStore[env][path] && fsStore[env][path].type === "folder") {
        current = path;
        renderShortcuts();
      }
      renderContents();
      renderViewer(path);
    }

    // Initialize on page load
    window.onload = () => {
      setEnv(env);
      buildTree(env === "LOCAL" ? "C:" : "VIRTUAL:", document.getElementById("tree"));
      navigate(current);
    };
  </script>
</body>
</html>
