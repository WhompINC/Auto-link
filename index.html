<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SDU Shield Explorer</title>
  <style>
    html, body { height:100%; margin:0; font-family: monospace; background:#1e1e1e; color:#ddd; }
    .grid { display:grid; grid-template-columns:250px 1fr; grid-template-rows:auto auto 1fr;
      grid-template-areas:
        "sidebar header"
        "sidebar controls"
        "sidebar viewer"; height:100%; }

    /* Sidebar */
    #sidebar { grid-area:sidebar; background:#2d2d2d; padding:10px; overflow-y:auto; }
    #sidebar h3 { margin:0 0 8px; color:#ccc; }
    #sidebar ul { list-style:none; padding:0; margin:0; }
    #sidebar ul ul { display:none; margin-left:16px; }
    #sidebar li { padding:4px 8px; position:relative; cursor:pointer; user-select:none;
      transition:background .1s; }
    #sidebar li.folder::before { content:'‚ñ∂'; position:absolute; left:0; }
    #sidebar li.folder.expanded::before { content:'‚ñº'; }
    #sidebar li.file::before { content:'üìÑ'; position:absolute; left:0; }
    #sidebar li:hover { background:#3a3a3a; }
    #sidebar li:active { background:#555; }

    /* Header */
    #header { grid-area:header; display:flex; align-items:center; background:#333; padding:8px;
      border-bottom:1px solid #444; }
    #header button { background:#444; color:#fff; border:none; padding:4px 8px; margin-right:8px;
      cursor:pointer; transition:background .1s; }
    #header button:hover { background:#555; }
    #header button:active { background:#777; transform:translateY(1px); }
    #header button:disabled { opacity:.4; cursor:default; }
    #path { flex:1; color:#569cd6; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Controls */
    #controls { grid-area:controls; display:flex; align-items:center; background:#333;
      padding:4px 8px; border-bottom:1px solid #444; }
    #controls input { flex:1; padding:4px 8px; background:#222; border:1px solid #444; color:#ddd;
      transition:border-color .2s; }
    #controls input:focus { border-color:#569cd6; outline:none; }
    #controls button { background:#444; color:#fff; border:none; padding:4px 8px; margin-left:8px;
      cursor:pointer; transition:background .1s; }
    #controls button:hover { background:#555; }
    #controls button:active { background:#777; transform:translateY(1px); }

    /* Viewer */
    #viewer { grid-area:viewer; padding:12px; overflow-y:auto; background:#252526; }
    .item { display:inline-block; width:120px; margin:8px; text-align:center; cursor:pointer;
      transition:background .1s; position:relative; }
    .item:hover { background:#3a3a3a; }
    .item:active { background:#555; }
    .icon { font-size:32px; }
    .name { margin-top:4px; font-size:14px; word-break:break-word; }
    .download-btn { background:transparent; border:none; font-size:16px; color:#0e639c;
      margin-top:4px; cursor:pointer; transition:background .1s; }
    .download-btn:hover { background:#555; }
    .download-btn:active { background:#777; transform:translateY(1px); }

    pre { white-space:pre-wrap; background:#1e1e1e; padding:8px; border:1px solid #444; color:#ddd; }
  </style>
</head>
<body>
  <div class="grid">
    <div id="sidebar">
      <h3>Files</h3>
      <ul id="tree"></ul>
    </div>

    <div id="header">
      <button id="back">‚óÄ</button>
      <button id="forward">‚ñ∂</button>
      <span id="path">Loading...</span>
    </div>

    <div id="controls">
      <button id="refresh">üîÑ Refresh</button>
      <input id="search" placeholder="Search..." />
      <button id="search-btn">üîç</button>
    </div>

    <div id="viewer"><pre id="doc-view">Select a file or folder</pre></div>
  </div>

  <script>
    // Extended icon map
    const icons = {
      png:'üñºÔ∏è', jpg:'üñºÔ∏è', jpeg:'üñºÔ∏è', gif:'üñºÔ∏è',
      zip:'üóúÔ∏è', html:'üåê', css:'üé®', json:'üóÉÔ∏è', ini:'‚öôÔ∏è',
      c:'üíª', h:'üíª', txt:'üìÑ', md:'üìù', py:'üêç', js:'üìú'
    };

    let treeData={}, hist=[], pos=-1;
    let filters={ env:null, exts:[], names:[], text:[] };

    const treeEl=document.getElementById('tree'),
          viewer=document.getElementById('viewer'),
          docView=document.getElementById('doc-view'),
          pathEl=document.getElementById('path'),
          backBtn=document.getElementById('back'),
          fwdBtn=document.getElementById('forward'),
          searchEl=document.getElementById('search'),
          searchBtn=document.getElementById('search-btn'),
          refreshBtn=document.getElementById('refresh');

    // Load JSON map
    async function loadTree(){
      try {
        const res=await fetch('file_tree.json');
        treeData=await res.json();
        renderSidebar();
        navigate(Object.keys(treeData)[0]);
      } catch(e){
        pathEl.textContent='Failed to load tree';
        console.error(e);
      }
    }

    // Build sidebar
    function renderSidebar(){
      treeEl.innerHTML='';
      Object.entries(treeData).forEach(([env,node])=>{
        const li=document.createElement('li');
        li.textContent=env; li.classList.add('folder');
        const childUl=document.createElement('ul'); childUl.style.display='none';
        buildNode(node, childUl, env, li);
        li.appendChild(childUl);
        treeEl.appendChild(li);
      });
    }

    // Recursive sidebar builder
    function buildNode(obj, ul, path, parentLi){
      Object.entries(obj).forEach(([name,val])=>{
        const full=path+'/'+name;
        const li=document.createElement('li');
        li.textContent=name;
        if(typeof val==='object'){
          li.classList.add('folder');
          const subUl=document.createElement('ul'); subUl.style.display='none';
          buildNode(val, subUl, full, li);
          li.appendChild(subUl);
          li.addEventListener('click', e=>{
            e.stopPropagation();
            const exp=subUl.style.display==='none';
            li.classList.toggle('expanded',exp);
            subUl.style.display=exp?'block':'none';
            navigate(full);
            // sync parent expand
            if(exp) parentLi.classList.add('expanded');
          });
        } else {
          li.classList.add('file');
          li.addEventListener('click', e=>{
            e.stopPropagation();
            navigate(full);
          });
        }
        ul.appendChild(li);
      });
    }

    // Navigate to path
    async function navigate(path){
      if(hist[pos]!==path){
        hist=hist.slice(0,pos+1); hist.push(path); pos=hist.length-1; updateNav();
      }
      pathEl.textContent=path;
      if(filters.text.length) return applySearch();

      const [env,...rest]=path.split('/');
      let node=treeData[env]; rest.forEach(p=>node=node[p]);

      viewer.innerHTML='';
      if(typeof node==='object'){
        Object.entries(node).forEach(([name,val])=>showItem(env+'/'+name,val));
      } else {
        try{
          const res=await fetch(path);
          const txt=await res.text();
          viewer.innerHTML=`<pre>${txt}</pre>`;
        }catch{
          docView.textContent='Error loading file';
        }
      }
      // expand in sidebar
      syncExpand(path);
    }

    // Show a file/folder card
    function showItem(full,val){
      const name=full.split('/').pop(),
            ext=name.split('.').pop().toLowerCase(),
            icon=typeof val==='object'?'üìÅ':(icons[ext]||'üìÑ');

      const div=document.createElement('div');
      div.className='item';
      div.innerHTML=`<div class="icon">${icon}</div><div class="name">${name}</div>`;
      div.addEventListener('click',()=>navigate(full));

      if(typeof val!=='object'){
        const dl=document.createElement('button');
        dl.className='download-btn';
        dl.textContent='‚¨áÔ∏è';
        dl.addEventListener('click', e=>{
          e.stopPropagation();
          window.open(full,'_blank');
        });
        div.appendChild(dl);
      }
      viewer.appendChild(div);
    }

    // Sync expansion in sidebar when clicking viewer
    function syncExpand(path){
      const parts=path.split('/');
      let selector='#tree > li';
      parts.forEach((p,i)=>{
        const list=document.querySelectorAll(selector);
        list.forEach(li=>{
          if(li.firstChild.textContent===p){
            if(i<parts.length-1){
              // expand
              li.classList.add('expanded');
              const child=li.querySelector('ul');
              if(child) child.style.display='block';
            }
          }
        });
        selector+=' > ul > li';
      });
    }

    // Navigation buttons
    function updateNav(){
      backBtn.disabled=pos<=0;
      fwdBtn.disabled=pos>=hist.length-1;
    }
    backBtn.addEventListener('click',()=>{ if(pos>0) navigate(hist[--pos]); });
    fwdBtn.addEventListener('click',()=>{ if(pos<hist.length-1) navigate(hist[++pos]); });

    // Refresh
    refreshBtn.addEventListener('click',()=>{
      filters.text=[]; searchEl.value='';
      loadTree();
    });

    // Search with filters
    searchEl.addEventListener('input',applySearch);
    searchEl.addEventListener('keydown',e=>{ if(e.key==='Enter') e.preventDefault(); });
    searchBtn.addEventListener('click',applySearch);

    function applySearch(){
      const raw=searchEl.value.trim().toLowerCase();
      filters={ env:null, exts:[], names:[], text:[] };
      raw.split(/\s+/).forEach(tok=>{
        if(tok==='local:'||tok==='l/') filters.env='LOCAL';
        else if(tok==='virtual:'||tok==='v:') filters.env='VIRTUAL';
        else if(tok.startsWith('file.')||tok.startsWith('f.')) filters.names.push(tok.split('.')[1]);
        else if(tok.startsWith('.')) filters.exts.push(tok.slice(1));
        else if(tok) filters.text.push(tok);
      });
      const results=[];
      function walk(o,p){
        Object.entries(o).forEach(([n,v])=>{
          const fp=p+'/'+n, ext=n.split('.').pop().toLowerCase();
          if(typeof v==='object') return walk(v,fp);
          if(filters.env && !fp.startsWith(filters.env+'/')) return;
          if(filters.exts.length && !filters.exts.includes(ext)) return;
          if(filters.names.length && !filters.names.some(f=>n.includes(f))) return;
          if(filters.text.length && !filters.text.every(t=>fp.includes(t))) return;
          results.push([fp,v]);
        });
      }
      Object.entries(treeData).forEach(([env,node])=>{
        if(!filters.env||filters.env===env) walk(node,env);
      });
      viewer.innerHTML='';
      if(results.length){
        results.forEach(([fp,val])=>showItem(fp,val));
      } else {
        viewer.innerHTML=`<pre>No matches for ‚Äú${searchEl.value}‚Äù</pre>`;
      }
    }

    window.onload=loadTree;
  </script>
</body>
</html>
