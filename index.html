<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SDU Shield Explorer</title>
  <style>
    html,body{height:100%;margin:0;font-family:monospace;background:#1e1e1e;color:#ddd}
    .grid{display:grid;grid-template-columns:250px 1fr;grid-template-rows:auto auto 1fr;grid-template-areas:
      "sidebar header"
      "sidebar controls"
      "sidebar viewer";height:100%}
    /* Sidebar */
    #sidebar{grid-area:sidebar;background:#2d2d2d;padding:10px;overflow-y:auto;}
    #sidebar h3{margin:0 0 8px;color:#ccc}
    #sidebar ul, #sidebar ul ul{list-style:none;padding:0;margin:0}
    #sidebar ul ul{display:none;margin-left:16px}
    #sidebar li{padding:4px 8px 4px 24px;cursor:pointer;position:relative;user-select:none;transition:background .1s}
    #sidebar li.folder::before{content:'â–¶';position:absolute;left:8px}
    #sidebar li.folder.expanded::before{content:'â–¼'}
    #sidebar li.file::before{position:absolute;left:8px}
    /* Emojis by extension */
    #sidebar li.file.png::before  {content:'ğŸ–¼ï¸'}
    #sidebar li.file.jpg::before  {content:'ğŸ–¼ï¸'}
    #sidebar li.file.jpeg::before {content:'ğŸ–¼ï¸'}
    #sidebar li.file.gif::before  {content:'ğŸ–¼ï¸'}
    #sidebar li.file.zip::before  {content:'ğŸ—œï¸'}
    #sidebar li.file.html::before {content:'ğŸŒ'}
    #sidebar li.file.css::before  {content:'ğŸ¨'}
    #sidebar li.file.json::before {content:'ğŸ—ƒï¸'}
    #sidebar li.file.ini::before  {content:'âš™ï¸'}
    #sidebar li.file.c::before    {content:'ğŸ’»'}
    #sidebar li.file.h::before    {content:'ğŸ’»'}
    #sidebar li.file.txt::before  {content:'ğŸ“„'}
    #sidebar li.file.md::before   {content:'ğŸ“'}
    #sidebar li.file.py::before   {content:'ğŸ'}
    #sidebar li.file.js::before   {content:'ğŸ“œ'}
    #sidebar li:hover{background:#3a3a3a}
    #sidebar li:active{background:#555}
    /* Header */
    #header{grid-area:header;display:flex;align-items:center;background:#333;padding:8px;border-bottom:1px solid #444}
    #header button{background:#444;color:#fff;border:none;padding:4px 8px;margin-right:8px;cursor:pointer;transition:background .1s,transform .1s}
    #header button:hover{background:#555}
    #header button:active{background:#777;transform:translateY(1px)}
    #header button:disabled{opacity:.4;cursor:default}
    #path{flex:1;color:#569cd6;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    /* Controls */
    #controls{grid-area:controls;display:flex;align-items:center;background:#333;padding:4px 8px;border-bottom:1px solid #444}
    #controls input{flex:1;padding:4px 8px;background:#222;border:1px solid #444;color:#ddd;transition:border-color .2s}
    #controls input:focus{border-color:#569cd6;outline:none}
    #controls button{background:#444;color:#fff;border:none;padding:4px 8px;margin-left:8px;cursor:pointer;transition:background .1s,transform .1s}
    #controls button:hover{background:#555}
    #controls button:active{background:#777;transform:translateY(1px)}
    /* Viewer */
    #viewer{grid-area:viewer;padding:12px;overflow-y:auto;background:#252526}
    .item{display:inline-block;width:120px;margin:8px;text-align:center;cursor:pointer;transition:background .1s,transform .1s;position:relative}
    .item:hover{background:#3a3a3a}
    .item:active{background:#555;transform:translateY(1px)}
    .icon{font-size:32px}
    .name{margin-top:4px;font-size:14px;word-break:break-word}
    .download-btn{position:absolute;bottom:4px;right:4px;background:transparent;border:none;font-size:16px;color:#0e639c;cursor:pointer;transition:background .1s,transform .1s}
    .download-btn:hover{background:#555}
    .download-btn:active{background:#777;transform:translateY(1px)}
    pre{white-space:pre-wrap;background:#1e1e1e;padding:8px;border:1px solid #444;color:#ddd}
  </style>
</head>
<body>
  <div class="grid">
    <div id="sidebar">
      <h3>ğŸ“ Files</h3><ul id="tree"></ul>
    </div>
    <div id="header">
      <button id="back">â—€</button>
      <button id="forward">â–¶</button>
      <span id="path">Loading...</span>
    </div>
    <div id="controls">
      <button id="refresh">ğŸ”„ Loading...</button>
      <input id="search" placeholder="Search..." />
      <button id="search-btn">ğŸ”</button>
    </div>
    <div id="viewer"><pre id="doc-view">Select a file or folder</pre></div>
  </div>

  <script>
    const REMOTE = 'https://whompinc.github.io/Files/file_tree.json';
    const LOCAL  = 'file_tree.json';
    const icons = { png:'ğŸ–¼ï¸', jpg:'ğŸ–¼ï¸', jpeg:'ğŸ–¼ï¸', gif:'ğŸ–¼ï¸',
      zip:'ğŸ—œï¸', html:'ğŸŒ', css:'ğŸ¨', json:'ğŸ—ƒï¸', ini:'âš™ï¸',
      c:'ğŸ’»', h:'ğŸ’»', txt:'ğŸ“„', md:'ğŸ“', py:'ğŸ', js:'ğŸ“œ' };
    let treeData={}, hist=[], pos=-1, filters={env:null,exts:[],names:[],text:[]};
    const treeEl=document.getElementById('tree'),
          viewer=document.getElementById('viewer'),
          docView=document.getElementById('doc-view'),
          pathEl=document.getElementById('path'),
          backBtn=document.getElementById('back'),
          fwdBtn=document.getElementById('forward'),
          searchEl=document.getElementById('search'),
          searchBtn=document.getElementById('search-btn'),
          refreshBtn=document.getElementById('refresh');

    // Lastâ€updated timer
    let lastFetched=0;
    function updateBadge(){
      const d=Date.now()-lastFetched, s=Math.floor(d/1000);
      let txt;
      if(s<60) txt=`${s}s ago`;
      else if(s<3600) txt=`${Math.floor(s/60)}m ago`;
      else if(s<86400) txt=`${Math.floor(s/3600)}h ago`;
      else if(s<2592000) txt=`${Math.floor(s/86400)}d ago`;
      else if(s<31536000) txt=`${Math.floor(s/2592000)}mo ago`;
      else txt=`${Math.floor(s/31536000)}y ago`;
      refreshBtn.textContent = 'ğŸ”„ ' + txt;
    }
    setInterval(updateBadge,1000);

    async function fetchTree(){
      try {
        const r=await fetch(REMOTE+'?cb='+Date.now());
        if(!r.ok) throw 0;
        const j=await r.json();
        console.log('Loaded remote');
        return j;
      } catch(e){
        console.warn('Remote failed, using local',e);
        const r2=await fetch(LOCAL+'?cb='+Date.now());
        if(!r2.ok) throw 'All fetch failed';
        console.log('Loaded local');
        return r2.json();
      }
    }

    async function loadTree(){
      try {
        treeData = await fetchTree();
        lastFetched = Date.now();
        renderSidebar();
        navigate(Object.keys(treeData)[0]);
      } catch(e){
        console.error(e);
        pathEl.textContent='Failed to load tree';
      }
    }

    function renderSidebar(){
      treeEl.innerHTML='';
      for(const [env,node] of Object.entries(treeData)){
        const li=document.createElement('li'), ul=document.createElement('ul');
        li.textContent=env; li.classList.add('folder'); ul.style.display='none';
        buildNode(node,ul,env,li);
        li.appendChild(ul);
        treeEl.appendChild(li);
      }
    }

    function buildNode(obj,ul,path){
      for(const [name,val] of Object.entries(obj)){
        const full=path+'/'+name, li=document.createElement('li'), ext=name.split('.').pop().toLowerCase();
        li.textContent=name;
        if(typeof val==='object'){
          li.classList.add('folder');
          const sub=document.createElement('ul'); sub.style.display='none';
          buildNode(val,sub,full);
          li.appendChild(sub);
          li.addEventListener('click',e=>{
            e.stopPropagation();
            const exp=sub.style.display==='none';
            li.classList.toggle('expanded',exp);
            sub.style.display=exp?'block':'none';
            navigate(full);
          });
        } else {
          li.classList.add('file',ext);
          li.addEventListener('click',e=>{e.stopPropagation();navigate(full)});
        }
        ul.appendChild(li);
      }
    }

    async function navigate(path,push=true){
      if(push && hist[pos]!==path){
        hist=hist.slice(0,pos+1);hist.push(path);pos=hist.length-1;updateNav();
      }
      pathEl.textContent=path;viewer.innerHTML='';
      const [env,...rest]=path.split('/');let node=treeData[env];rest.forEach(p=>node=node[p]);
      if(typeof node==='object'){
        for(const [name,val] of Object.entries(node))showItem(env+'/'+name,val);
      } else {
        try{
          const t=await (await fetch(path)).text();
          viewer.innerHTML=`<pre>${t}</pre>`;
        } catch{
          docView.textContent='Error loading file';
        }
      }
      syncExpand(path);
    }

    function showItem(full,val){
      const name=full.split('/').pop(),
            ext=name.split('.').pop().toLowerCase(),
            icon=typeof val==='object'?'ğŸ“':(icons[ext]||'ğŸ“„'),
            div=document.createElement('div');
      div.className='item';div.innerHTML=`<div class="icon">${icon}</div><div class="name">${name}</div>`;
      div.addEventListener('click',()=>navigate(full));
      if(typeof val!=='object'){
        const dl=document.createElement('button');dl.className='download-btn';dl.textContent='â¬‡ï¸';
        dl.addEventListener('click',e=>{
          e.stopPropagation();
          fetch(full).then(r=>r.blob()).then(b=>{
            const u=URL.createObjectURL(b), a=document.createElement('a');
            a.href=u;a.download=name;document.body.appendChild(a);a.click();
            document.body.removeChild(a);URL.revokeObjectURL(u);
          });
        });
        div.appendChild(dl);
      }
      viewer.appendChild(div);
    }

    function syncExpand(path){
      const parts=path.split('/');let sel='#tree > li';
      parts.forEach((p,i)=>{
        document.querySelectorAll(sel).forEach(li=>{
          if(li.firstChild.textContent===p && i<parts.length-1){
            li.classList.add('expanded');
            const c=li.querySelector('ul');if(c)c.style.display='block';
          }
        });
        sel+=' > ul > li';
      });
    }

    function updateNav(){
      backBtn.disabled=pos<=0;fwdBtn.disabled=pos>=hist.length-1;
    }
    backBtn.onclick = ()=>{if(pos>0)navigate(hist[--pos],false)};
    fwdBtn.onclick  = ()=>{if(pos<hist.length-1)navigate(hist[++pos],false)};

    refreshBtn.onclick = loadTree;
    searchEl.oninput = applySearch;
    searchBtn.onclick = applySearch;

    function applySearch(){
      const raw=searchEl.value.trim().toLowerCase();
      filters={env:null,exts:[],names:[],text:[]};
      raw.split(/\s+/).forEach(tok=>{
        if(tok==='l/'||tok==='local:') filters.env='directory_GPT';
        else if(tok==='v/'||tok==='virtual:') filters.env='virtual';
        else if(tok.startsWith('file.')||tok.startsWith('f.')) filters.names.push(tok.split('.')[1]);
        else if(tok.startsWith('.')) filters.exts.push(tok.slice(1));
        else if(tok) filters.text.push(tok);
      });
      const res=[];
      function walk(o,p){
        for(const [n,v] of Object.entries(o)){
          const fp=p+'/'+n, e=n.split('.').pop().toLowerCase();
          if(typeof v==='object'){walk(v,fp);continue}
          if(filters.env && p!==filters.env) continue;
          if(filters.exts.length && !filters.exts.includes(e)) continue;
          if(filters.names.length && !filters.names.some(f=>n.includes(f))) continue;
          if(filters.text.length && !filters.text.every(t=>fp.includes(t))) continue;
          res.push([fp,v]);
        }
      }
      for(const [env,node] of Object.entries(treeData)){
        if(!filters.env||filters.env===env) walk(node,env);
      }
      viewer.innerHTML='';
      if(res.length) res.forEach(([fp,v])=>showItem(fp,v));
      else viewer.innerHTML=`<pre>No matches for â€œ${searchEl.value}â€</pre>`;
    }

    window.onload = () => {
      loadTree();
      setInterval(loadTree,30000);
    };
  </script>
</body>
</html>
